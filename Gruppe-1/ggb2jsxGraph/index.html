<html>
    <head>
        <meta charset='UTF-8'>
        <link rel='stylesheet' type='text/css' href='jsxgraph.css'>
        <script src='jquery-1.12.0.min.js' type='text/javascript'></script>
        <script src='jsxgraphcore.js' type='text/javascript'></script>
        <script src='geogebra.js' type='text/javascript'></script>
        <script src='xml_transformer.js' type='text/javascript'></script>
    </head>
    <body>
        <div>
            <div style='width: 45%; height: 95%; float: left'>
                <div>
                    <select id='inputFormatSelect'>
                        <option value='ggb'>Read Geogebra files</option>
                        <option value='geoproof'>Read Geoproof schemes</option>
                    </select>
                </div>
                <div id='ggbInputControl' style='width: 100%; margin-top: 5px'>
                    <label style='margin-right: 10px'>Select Geogebra XML file or GGB archive: </label>
                    <input type='file' id='ggbFileSelect' accept='.ggb,.xml'/>
                </div>
                <div id='geoproofInputControl' style='width: 100%; margin-top: 5px; display: none'>
                    <label style='margin-right: 10px'>Select Geoproof XML file: </label>
                    <input type='file' id='geoproofFileSelect' accept='.xml'/>
                </div>
                <br />
                <textarea id='xmlContainer' style='width: 100%; height: 80%'>
                </textarea>
                <button id='readFromTextarea'>Parse from text area</button>
            </div>
            <div id='box' class='jxgbox' style='width: 50%; height: 95%; float: right'></div>
        </div>
        <script type='text/javascript'>
            // doesn't work on Chrome which by default does not allow XHRs for local files
            //let board = JXG.JSXGraph.loadBoardFromFile('box', 'geogebra-export.ggb', 'Geogebra');
            let board = JXG.JSXGraph.initBoard('box', {boundingbox: [-10, 10, 10, -10], axis:true});
            const $xmlContainer = $('#xmlContainer');

            let inputFormat = 'ggb';
            // read previously selected input format from local storage
            $(document).ready(() => {
                if (window.localStorage) {
                    inputFormat = localStorage.getItem('inputFormat');
                    if (inputFormat) setInputFormat(inputFormat);
                }
            });
            $('#inputFormatSelect').change((event) => {
                inputFormat = event.currentTarget.value;
                setInputFormat(inputFormat);
            });

            $('#ggbFileSelect, #geoproofFileSelect').change(handleUploadFile);
            $('#readFromTextarea').click(handleReadFromTextarea);

            function setInputFormat(inputFormat) {
                if (window.localStorage) {
                    localStorage.setItem('inputFormat', inputFormat);
                }
                // so the dropdown gets updated even if the input format is set from elsewhere
                // (this will not call the change handler again)
                $('#inputFormatSelect').val(inputFormat);
                if (inputFormat === 'ggb') {
                    $('#ggbInputControl').show();
                    $('#geoproofInputControl').hide();
                } else {
                    $('#geoproofInputControl').show();
                    $('#ggbInputControl').hide();
                }
            }
            function loadFromText(format, text) {
                return (format === 'ggb' ? loadGgbFromText(text) : loadGeoproofFromText(text));
            }
            function loadGgbFromText(inputText) {
                // board needs to be reset before loading new constructions
                board = JXG.JSXGraph.initBoard('box', {boundingbox: [-10, 10, 10, -10], axis:true});
                const ggbReader = new JXG.GeogebraReader(board, inputText);
                // can't put inputText into xmlContainer directly, might be a compressed ggb
                $xmlContainer.val(new XMLSerializer().serializeToString(ggbReader.tree.documentElement));
                ggbReader.read();
            }
            function loadGeoproofFromText(inputText) {
                loadGgbFromText(transformXml(inputText));
            }

            function handleUploadFile() {
                const file = this.files[0];
                if (!file) {
                    $xmlContainer.val('No file found');
                    return;
                }
                if (!window.FileReader) {
                    $xmlContainer.val('Your browser does not support the FileReader API');
                    return;
                }
                
                const reader = new FileReader();
                reader.onloadend = () => {
                    loadFromText(inputFormat, reader.result);
                };
                reader.readAsText(file, 'ISO-8859-1');
            }

            function handleReadFromTextarea() {
                loadFromText(inputFormat, $xmlContainer.val());
            }
        </script>
    </body>
</html>
